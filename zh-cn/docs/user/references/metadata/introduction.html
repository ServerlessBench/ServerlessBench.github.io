<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="introduction" />
	<meta name="description" content="introduction" />
	<!-- 网页标签标题 -->
	<title>introduction</title>
	<link rel="shortcut icon" href="/img/dubbo.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/dubbo_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a target="_self" href="/zh-cn/index.html">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a target="_self" href="/zh-cn/docs/user/quick-start.html">文档</a></li><li class="menu-item menu-item-normal"><a target="_self" href="/zh-cn/docs/developers/developers_dev.html">开发者</a></li><li class="menu-item menu-item-normal"><a target="_self" href="/zh-cn/blog/download.html">下载</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/docs.png" class="front-img"/><span>文档</span><img src="/img/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>文档</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/user/preface/background.html" target="_self">背景</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/user/quick-start.html" target="_self">快速开始</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>背景</h1>
<p>dubbo provider中的服务配置项有接近<a href="http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-service.html">30个配置项</a>。 排除注册中心服务治理需要之外，很大一部分配置项是provider自己使用，不需要透传给消费者。这部分数据不需要进入注册中心，而只需要以key-value形式持久化存储。
dubbo consumer中的配置项也有<a href="http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-reference.html">20+个配置项</a>。在注册中心之中，服务消费者列表中只需要关注application，version，group，ip，dubbo版本等少量配置，其他配置也可以以key-value形式持久化存储。
这些数据是以服务为维度注册进入注册中心，导致了数据量的膨胀，进而引发注册中心(如zookeeper)的网络开销增大，性能降低。<br>
除了上述配置项的存储之外，dubbo服务元数据信息也需要被存储下来。元数据信息包括服务接口，及接口的方法信息。这些信息将被用于服务mock，服务测试。</p>
<h1>目标</h1>
<p>需要将注册中心原来的数据信息和元数据信息保存到独立的key-value的存储中，这个key-value可以是DB，redis或者其他持久化存储。核心代码中支持了zookeeper，redis(推荐)的默认支持。</p>
<p>provider存储内容的格式，参见：org.apache.dubbo.metadata.definition.model.FullServiceDefinition。是该类型gson化之后的存储。
Consumer存储内容，为Map格式。从Consumer端注册到注册中心的URL中的获取参数信息。即通过URL.getParameterMap()获取到的Map，进行gson化之后进行存储。</p>
<p>详细的内容，可以参考下面的sample输出。</p>
<h1>配置</h1>
<p>默认的元数据存储，额外支持以下几个特性：</p>
<ul>
<li>失败重试</li>
<li>每天定时重刷</li>
</ul>
<h4>失败重试</h4>
<p>失败重试可以通过retrytimes （重试次数,默认100），retryperiod（重试周期，默认3000ms）进行设置。</p>
<h4>定时刷新</h4>
<p>默认开启，可以通过设置cycleReport=false进行关闭。</p>
<h4>完整的配置项：</h4>
<pre><code>dubbo.metadata-report.address=zookeeper://127.0.0.1:2181
dubbo.metadata-report.username=xxx        ##非必须
dubbo.metadata-report.password=xxx        ##非必须
dubbo.metadata-report.retry-times=30       ##非必须,default值100
dubbo.metadata-report.retry-period=5000    ##非必须,default值3000
dubbo.metadata-report.cycle-report=false   ##非必须,default值true
</code></pre>
<blockquote>
<p>如果元数据地址(dubbo.metadata-report.address)也不进行配置，整个元数据的写入不会生效，但是不影响程序运行。</p>
</blockquote>
<p>接下来看几个sample的配置。无论哪种配置方式，都需要引入maven依赖：</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;
    &lt;artifactId&gt;dubbo-metadata-report-zookeeper&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>如果需要使用redis，可以引入对应的redis的依赖：</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;
    &lt;artifactId&gt;dubbo-metadata-report-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<blockquote>
<p><strong>完整的sample，查看<a href="https://github.com/dubbo/dubbo-samples/tree/master">sample-2.7</a></strong></p>
</blockquote>
<h2>方式一：在配置中心配置</h2>
<p>参考sample：dubbo-samples-metadata-report/dubbo-samples-metadata-report-configcenter 工程。</p>
<h5>配置中心配置</h5>
<p>配置中心的配置，可以参考configcenter的文档。配置的内容如下：</p>
<pre><code class="language-.properties">dubbo.registry.address=zookeeper://127.0.0.1:2181
### 注意驼峰式风格
dubbo.metadata-report.address=zookeeper://127.0.0.1:2181 ###元数据存储的地址
</code></pre>
<p>在sample中，使用了Zookeeper作为配置中心。启动本地zookeeper服务之后，直接运行：org.apache.dubbo.samples.metadatareport.configcenter.ZKTools 就可以完成写入。
如果配置中心使用了nacos，apollo，这些产品本身支持ops配置。</p>
<h5>应用配置</h5>
<pre><code>###dubbo.properties
dubbo.config-center.address=zookeeper://127.0.0.1:2181
... 
</code></pre>
<p>完成上述两步之后，注册中心地址、元数据地址将从配置中心进行获取。现在可以依次运行Provider类和Consumer类，会在console中得到对应的输出或者直接通过zookeeper的cli查看。</p>
<h5>Provider配置</h5>
<p>provider端存储的元数据内容如下：</p>
<pre><code class="language-json">{
 <span class="hljs-attr">"parameters"</span>: {
  <span class="hljs-attr">"side"</span>: <span class="hljs-string">"provider"</span>,
  <span class="hljs-attr">"methods"</span>: <span class="hljs-string">"sayHello"</span>,
  <span class="hljs-attr">"dubbo"</span>: <span class="hljs-string">"2.0.2"</span>,
  <span class="hljs-attr">"threads"</span>: <span class="hljs-string">"100"</span>,
  <span class="hljs-attr">"interface"</span>: <span class="hljs-string">"org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService"</span>,
  <span class="hljs-attr">"threadpool"</span>: <span class="hljs-string">"fixed"</span>,
  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.1.1"</span>,
  <span class="hljs-attr">"generic"</span>: <span class="hljs-string">"false"</span>,
  <span class="hljs-attr">"revision"</span>: <span class="hljs-string">"1.1.1"</span>,
  <span class="hljs-attr">"valid"</span>: <span class="hljs-string">"true"</span>,
  <span class="hljs-attr">"application"</span>: <span class="hljs-string">"metadatareport-configcenter-provider"</span>,
  <span class="hljs-attr">"default.timeout"</span>: <span class="hljs-string">"5000"</span>,
  <span class="hljs-attr">"group"</span>: <span class="hljs-string">"d-test"</span>,
  <span class="hljs-attr">"anyhost"</span>: <span class="hljs-string">"true"</span>
 },
 <span class="hljs-attr">"canonicalName"</span>: <span class="hljs-string">"org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService"</span>,
 <span class="hljs-attr">"codeSource"</span>: <span class="hljs-string">"file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-configcenter/target/classes/"</span>,
 <span class="hljs-attr">"methods"</span>: [{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"sayHello"</span>,
  <span class="hljs-attr">"parameterTypes"</span>: [<span class="hljs-string">"java.lang.String"</span>],
  <span class="hljs-attr">"returnType"</span>: <span class="hljs-string">"java.lang.String"</span>
 }],
 <span class="hljs-attr">"types"</span>: [{
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"java.lang.String"</span>,
  <span class="hljs-attr">"properties"</span>: {
   <span class="hljs-attr">"value"</span>: {
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"char[]"</span>
   },
   <span class="hljs-attr">"hash"</span>: {
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"int"</span>
   }
  }
 }, {
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"int"</span>
 }, {
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"char"</span>
 }]
}

</code></pre>
<p>provider存储的内容包括了provider服务往注册中心填写的全部参数，以及服务的方法信息（方法名，入参出参的格式）。</p>
<h5>Consumer配置：</h5>
<pre><code>{
 &quot;valid&quot;: &quot;true&quot;,
 &quot;side&quot;: &quot;consumer&quot;,
 &quot;application&quot;: &quot;metadatareport-configcenter-consumer&quot;,
 &quot;methods&quot;: &quot;sayHello&quot;,
 &quot;default.timeout&quot;: &quot;6666&quot;,
 &quot;dubbo&quot;: &quot;2.0.2&quot;,
 &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService&quot;,
 &quot;version&quot;: &quot;1.1.1&quot;,
 &quot;revision&quot;: &quot;1.1.1&quot;,
 &quot;group&quot;: &quot;d-test&quot;
}
</code></pre>
<p>consumer端存储了consumer往注册中心填写的全部参数。</p>
<p>上面的例子，主要是将元数据地址放在配置中心，在元数据区存储下来的provider端服务信息和consumer端服务信息的展示。
接下来的两个例子，主要讲解在工程中配置：xml方式，annotation方式。</p>
<h2>方式二：配置在项目中-properties方式引入配置</h2>
<p>参考sample：dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-xml工程。</p>
<h5>dubbo.properties</h5>
<pre><code>dubbo.metadata-report.address=zookeeper://127.0.0.1:2181
</code></pre>
<p>配置完成这个之后，其余的不用特别关注。也可以直接查看对应的provider和consumer端的服务信息。</p>
<h5>provider存储的某个服务的内容：</h5>
<pre><code>{
 &quot;parameters&quot;: {
  &quot;valid&quot;: &quot;true&quot;,
  &quot;async&quot;: &quot;true&quot;,
  &quot;side&quot;: &quot;provider&quot;,
  &quot;application&quot;: &quot;metadatareport-local-xml-provider&quot;,
  &quot;methods&quot;: &quot;sayHello&quot;,
  &quot;dubbo&quot;: &quot;2.0.2&quot;,
  &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.xml.api.DemoService&quot;,
  &quot;generic&quot;: &quot;false&quot;,
  &quot;anyhost&quot;: &quot;true&quot;
 },
 &quot;canonicalName&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.xml.api.DemoService&quot;,
 &quot;codeSource&quot;: &quot;file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-xml/target/classes/&quot;,
 &quot;methods&quot;: [{
  &quot;name&quot;: &quot;sayHello&quot;,
  &quot;parameterTypes&quot;: [&quot;java.lang.String&quot;],
  &quot;returnType&quot;: &quot;java.lang.String&quot;
 }],
 &quot;types&quot;: [{
  &quot;type&quot;: &quot;int&quot;
 }, {
  &quot;type&quot;: &quot;char&quot;
 }, {
  &quot;type&quot;: &quot;java.lang.String&quot;,
  &quot;properties&quot;: {
   &quot;value&quot;: {
    &quot;type&quot;: &quot;char[]&quot;
   },
   &quot;hash&quot;: {
    &quot;type&quot;: &quot;int&quot;
   }
  }
 }]
}

</code></pre>
<h5>consumer端存储的内容：</h5>
<pre><code>{
 &quot;valid&quot;: &quot;true&quot;,
 &quot;side&quot;: &quot;consumer&quot;,
 &quot;application&quot;: &quot;metadatareport-local-xml-consumer&quot;,
 &quot;methods&quot;: &quot;sayHello&quot;,
 &quot;dubbo&quot;: &quot;2.0.2&quot;,
 &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.xml.api.DemoService&quot;
}

</code></pre>
<h2>方式三：配置在项目中-annotation方式引入配置</h2>
<p>参考sample：dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-annotaion工程。</p>
<h5>@Bean 引入bean</h5>
<pre><code>@Bean
public MetadataReportConfig metadataReportConfig() {
    MetadataReportConfig metadataReportConfig = new MetadataReportConfig();
    metadataReportConfig.setAddress(&quot;zookeeper://127.0.0.1:2181&quot;);
    return metadataReportConfig;
}

</code></pre>
<p>引入Bean之后，其余的地方也不需要特别配置。直接查看对应的服务信息：</p>
<h5>provider存储的某个服务的内容：</h5>
<pre><code>{
 &quot;parameters&quot;: {
  &quot;side&quot;: &quot;provider&quot;,
  &quot;methods&quot;: &quot;sayHello&quot;,
  &quot;dubbo&quot;: &quot;2.0.2&quot;,
  &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.annotation.api.AnnotationService&quot;,
  &quot;version&quot;: &quot;1.1.8&quot;,
  &quot;generic&quot;: &quot;false&quot;,
  &quot;revision&quot;: &quot;1.1.8&quot;,
  &quot;valid&quot;: &quot;true&quot;,
  &quot;application&quot;: &quot;metadatareport-local-annotaion-provider&quot;,
  &quot;default.timeout&quot;: &quot;1000&quot;,
  &quot;group&quot;: &quot;d-test&quot;,
  &quot;anyhost&quot;: &quot;true&quot;
 },
 &quot;canonicalName&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.annotation.api.AnnotationService&quot;,
 &quot;codeSource&quot;: &quot;file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-annotaion/target/classes/&quot;,
 &quot;methods&quot;: [{
  &quot;name&quot;: &quot;sayHello&quot;,
  &quot;parameterTypes&quot;: [&quot;java.lang.String&quot;],
  &quot;returnType&quot;: &quot;java.lang.String&quot;
 }],
 &quot;types&quot;: [{
  &quot;type&quot;: &quot;int&quot;
 }, {
  &quot;type&quot;: &quot;java.lang.String&quot;,
  &quot;properties&quot;: {
   &quot;value&quot;: {
    &quot;type&quot;: &quot;char[]&quot;
   },
   &quot;hash&quot;: {
    &quot;type&quot;: &quot;int&quot;
   }
  }
 }, {
  &quot;type&quot;: &quot;char&quot;
 }]
}
</code></pre>
<h5>consumer端存储的内容：</h5>
<pre><code>{
 &quot;valid&quot;: &quot;true&quot;,
 &quot;side&quot;: &quot;consumer&quot;,
 &quot;application&quot;: &quot;metadatareport-local-annotaion-consumer&quot;,
 &quot;methods&quot;: &quot;sayHello&quot;,
 &quot;dubbo&quot;: &quot;2.0.2&quot;,
 &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.annotation.api.AnnotationService&quot;,
 &quot;version&quot;: &quot;1.1.8&quot;,
 &quot;revision&quot;: &quot;1.1.8&quot;,
 &quot;group&quot;: &quot;d-test&quot;
}
</code></pre>
<h1>扩展</h1>
<h2>SPI定义</h2>
<p>参考：org.apache.dubbo.metadata.store.MetadataReportFactory ， org.apache.dubbo.metadata.store.MetadataReport</p>
<pre><code>@SPI(&quot;redis&quot;)
public interface MetadataReportFactory {
    @Adaptive({&quot;protocol&quot;})
    MetadataReport getMetadataReport(URL url);
}
</code></pre>
<h2>自定义元数据的存储</h2>
<p>下面以Redis存储为例进行说明。</p>
<p>新建一个project，需要支持以下修改：</p>
<h4>扩展AbstractMetadataReport</h4>
<pre><code>public class RedisMetadataReport extends AbstractMetadataReport {
    private final static Logger logger = LoggerFactory.getLogger(RedisMetadataReport.class);
    final JedisPool pool;
	
    public RedisMetadataReport(URL url) {
        super(url);
        pool = new JedisPool(new JedisPoolConfig(), url.getHost(), url.getPort());
    }
    @Override
    protected void doStoreProviderMetadata(ProviderMetadataIdentifier providerMetadataIdentifier, String serviceDefinitions) {
        this.storeMetadata(providerMetadataIdentifier, serviceDefinitions);
    }
    @Override
    protected void doStoreConsumerMetadata(ConsumerMetadataIdentifier consumerMetadataIdentifier, String value) {
        this.storeMetadata(consumerMetadataIdentifier, value);
    }
    private void storeMetadata(MetadataIdentifier metadataIdentifier, String v) {
        try (Jedis jedis = pool.getResource()) {
            jedis.set(metadataIdentifier.getIdentifierKey() + META_DATA_SOTRE_TAG, v);
        } catch (Throwable e) {
            logger.error(&quot;Failed to put &quot; + metadataIdentifier + &quot; to redis &quot; + v + &quot;, cause: &quot; + e.getMessage(), e);
            throw new RpcException(&quot;Failed to put &quot; + metadataIdentifier + &quot; to redis &quot; + v + &quot;, cause: &quot; + e.getMessage(), e);
        }
    }
}
</code></pre>
<h4>扩展AbstractMetadataReportFactory</h4>
<pre><code>public class RedisMetadataReportFactory extends AbstractMetadataReportFactory {
    @Override
    public MetadataReport createMetadataReport(URL url) {
        return new RedisMetadataReport(url);
    }
}
</code></pre>
<h4>增加META-INF/dubbo/internal/org.apache.dubbo.metadata.store.MetadataReportFactory</h4>
<pre><code>redis=org.apache.dubbo.metadata.store.redis.RedisMetadataReportFactory
</code></pre>
<p>只要将上面的修改和project打包成jar包，然后配置元数据中心的url：redis://10.20.153.10:6379。</p>
<p>至此，一个自定义的元数据存储就可以运行了。</p>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/dubbo_gray.png"/><img class="apache" src="/img/apache_logo.png"/><div class="cols-container"><div class="col col-12"><h3></h3><p></p></div><div class="col col-4"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/user/quick-start.html" target="_self">快速开始</a></dd><dd><a href="/zh-cn/docs/dev/build.html" target="_self">开发者指南</a></dd><dd><a href="/zh-cn/docs/admin/ops/dubbo-ops.html" target="_self">运维管理</a></dd><dd><a href="https://github.com/apache/dubbo-website/issues/new" target="_self">报告文档问题</a></dd><dd><a href="https://github.com/apache/dubbo-website" target="_self">编辑此文档</a></dd></dl></div></div><div class="copyright"><span>TODO Copyright © 2018-2019 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
  <script src="/build/documentation.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-112489517-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-112489517-1');
	</script>
</body>
</html>