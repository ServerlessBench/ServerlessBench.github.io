<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="dubbo" />
	<meta name="description" content="dubbo" />
	<!-- 网页标签标题 -->
	<title>dubbo</title>
	<link rel="shortcut icon" href="/img/dubbo.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/dubbo_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a target="_self" href="/zh-cn/index.html">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a target="_self" href="/zh-cn/docs/user/quick-start.html">文档</a></li><li class="menu-item menu-item-normal"><a target="_self" href="/zh-cn/docs/developers/developers_dev.html">开发者</a></li><li class="menu-item menu-item-normal"><a target="_self" href="/zh-cn/blog/download.html">下载</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/docs.png" class="front-img"/><span>文档</span><img src="/img/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>文档</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/user/preface/background.html" target="_self">背景</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/user/quick-start.html" target="_self">快速开始</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>dubbo://</h1>
<p>Dubbo 缺省协议采用单一长连接和 NIO 异步通讯，适合于小数据量大并发的服务调用，以及服务消费者机器数远大于服务提供者机器数的情况。</p>
<p>反之，Dubbo 缺省协议不适合传送大数据量的服务，比如传文件，传视频等，除非请求量很低。</p>
<p><img src="../../sources/images/dubbo-protocol.jpg" alt="dubbo-protocol.jpg"></p>
<ul>
<li>Transporter: mina, netty, grizzy</li>
<li>Serialization: dubbo, hessian2, java, json</li>
<li>Dispatcher: all, direct, message, execution, connection</li>
<li>ThreadPool: fixed, cached</li>
</ul>
<h2>特性</h2>
<p>缺省协议，使用基于 mina <code>1.1.7</code> 和 hessian <code>3.2.1</code> 的 tbremoting 交互。</p>
<ul>
<li>连接个数：单连接</li>
<li>连接方式：长连接</li>
<li>传输协议：TCP</li>
<li>传输方式：NIO 异步传输</li>
<li>序列化：Hessian 二进制序列化</li>
<li>适用范围：传入传出参数数据包较小（建议小于100K），消费者比提供者个数多，单一消费者无法压满提供者，尽量不要用 dubbo 协议传输大文件或超大字符串。</li>
<li>适用场景：常规远程服务方法调用</li>
</ul>
<h2>约束</h2>
<ul>
<li>参数及返回值需实现 <code>Serializable</code> 接口</li>
<li>参数及返回值不能自定义实现 <code>List</code>, <code>Map</code>, <code>Number</code>, <code>Date</code>, <code>Calendar</code> 等接口，只能用 JDK 自带的实现，因为 hessian 会做特殊处理，自定义实现类中的属性值都会丢失。</li>
<li>Hessian 序列化，只传成员属性值和值的类型，不传方法或静态变量，兼容情况 <sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>：</li>
</ul>
<table>
<thead>
<tr>
<th>数据通讯</th>
<th>情况</th>
<th>结果</th>
</tr>
</thead>
<tbody>
<tr>
<td>A-&gt;B</td>
<td>类A多一种 属性（或者说类B少一种 属性）</td>
<td>不抛异常，A多的那 个属性的值，B没有， 其他正常</td>
</tr>
<tr>
<td>A-&gt;B</td>
<td>枚举A多一种 枚举（或者说B少一种 枚举），A使用多 出来的枚举进行传输</td>
<td>抛异常</td>
</tr>
<tr>
<td>A-&gt;B</td>
<td>枚举A多一种 枚举（或者说B少一种 枚举），A不使用 多出来的枚举进行传输</td>
<td>不抛异常，B正常接 收数据</td>
</tr>
<tr>
<td>A-&gt;B</td>
<td>A和B的属性 名相同，但类型不相同</td>
<td>抛异常</td>
</tr>
<tr>
<td>A-&gt;B</td>
<td>serialId 不相同</td>
<td>正常传输</td>
</tr>
</tbody>
</table>
<p>接口增加方法，对客户端无影响，如果该方法不是客户端需要的，客户端不需要重新部署。输入参数和结果集中增加属性，对客户端无影响，如果客户端并不需要新属性，不用重新部署。</p>
<p>输入参数和结果集属性名变化，对客户端序列化无影响，但是如果客户端不重新部署，不管输入还是输出，属性名变化的属性值是获取不到的。</p>
<p>总结：服务器端和客户端对领域对象并不需要完全一致，而是按照最大匹配原则。</p>
<h2>配置</h2>
<p>配置协议：</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dubbo"</span> <span class="hljs-attr">port</span>=<span class="hljs-string">"20880"</span> /&gt;</span>
</code></pre>
<p>设置默认协议：</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:provider</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">"dubbo"</span> /&gt;</span>
</code></pre>
<p>设置服务协议：</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">protocol</span>=<span class="hljs-string">"dubbo"</span> /&gt;</span>
</code></pre>
<p>多端口：</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dubbo1"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dubbo"</span> <span class="hljs-attr">port</span>=<span class="hljs-string">"20880"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"dubbo2"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dubbo"</span> <span class="hljs-attr">port</span>=<span class="hljs-string">"20881"</span> /&gt;</span>
</code></pre>
<p>配置协议选项：</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">“dubbo”</span> <span class="hljs-attr">port</span>=<span class="hljs-string">“9090”</span> <span class="hljs-attr">server</span>=<span class="hljs-string">“netty”</span> <span class="hljs-attr">client</span>=<span class="hljs-string">“netty”</span> <span class="hljs-attr">codec</span>=<span class="hljs-string">“dubbo”</span> <span class="hljs-attr">serialization</span>=<span class="hljs-string">“hessian2”</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">“UTF-8”</span> <span class="hljs-attr">threadpool</span>=<span class="hljs-string">“fixed”</span> <span class="hljs-attr">threads</span>=<span class="hljs-string">“100”</span> <span class="hljs-attr">queues</span>=<span class="hljs-string">“0”</span> <span class="hljs-attr">iothreads</span>=<span class="hljs-string">“9”</span> <span class="hljs-attr">buffer</span>=<span class="hljs-string">“8192”</span> <span class="hljs-attr">accepts</span>=<span class="hljs-string">“1000”</span> <span class="hljs-attr">payload</span>=<span class="hljs-string">“8388608”</span> /&gt;</span>
</code></pre>
<p>多连接配置：</p>
<p>Dubbo 协议缺省每服务每提供者每消费者使用单一长连接，如果数据量较大，可以使用多个连接。</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">connections</span>=<span class="hljs-string">"1"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">connections</span>=<span class="hljs-string">"1"</span>/&gt;</span>
</code></pre>
<ul>
<li><code>&lt;dubbo:service connections=&quot;0&quot;&gt;</code> 或 <code>&lt;dubbo:reference connections=&quot;0&quot;&gt;</code> 表示该服务使用 JVM 共享长连接。<strong>缺省</strong></li>
<li><code>&lt;dubbo:service connections=&quot;1&quot;&gt;</code> 或 <code>&lt;dubbo:reference connections=&quot;1&quot;&gt;</code> 表示该服务使用独立长连接。</li>
<li><code>&lt;dubbo:service connections=&quot;2&quot;&gt;</code> 或<code>&lt;dubbo:reference connections=&quot;2&quot;&gt;</code> 表示该服务使用独立两条长连接。</li>
</ul>
<p>为防止被大量连接撑挂，可在服务提供方限制大接收连接数，以实现服务提供方自我保护。</p>
<pre><code class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dubbo:protocol</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dubbo"</span> <span class="hljs-attr">accepts</span>=<span class="hljs-string">"1000"</span> /&gt;</span>
</code></pre>
<p><code>dubbo.properties</code> 配置：</p>
<pre><code class="language-sh">dubbo.service.protocol=dubbo
</code></pre>
<h2>常见问题</h2>
<h4>为什么要消费者比提供者个数多?</h4>
<p>因 dubbo 协议采用单一长连接，假设网络为千兆网卡 <sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>，根据测试经验数据每条连接最多只能压满 7MByte(不同的环境可能不一样，供参考)，理论上 1 个服务提供者需要 20 个服务消费者才能压满网卡。</p>
<h4>为什么不能传大包?</h4>
<p>因 dubbo 协议采用单一长连接，如果每次请求的数据包大小为 500KByte，假设网络为千兆网卡 <sup class="footnote-ref"><a href="#fn3" id="fnref3:1">[3:1]</a></sup>，每条连接最大 7MByte(不同的环境可能不一样，供参考)，单个服务提供者的 TPS(每秒处理事务数)最大为：128MByte / 500KByte = 262。单个消费者调用单个服务提供者的 TPS(每秒处理事务数)最大为：7MByte / 500KByte = 14。如果能接受，可以考虑使用，否则网络将成为瓶颈。</p>
<h4>为什么采用异步单一长连接?</h4>
<p>因为服务的现状大都是服务提供者少，通常只有几台机器，而服务的消费者多，可能整个网站都在访问该服务，比如 Morgan 的提供者只有 6 台提供者，却有上百台消费者，每天有 1.5 亿次调用，如果采用常规的 hessian 服务，服务提供者很容易就被压跨，通过单一连接，保证单一消费者不会压死提供者，长连接，减少连接握手验证等，并使用异步 IO，复用线程池，防止 C10K 问题。</p>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p>由吴亚军提供 <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p>总结：会抛异常的情况：枚举值一边多一种，一边少一种，正好使用了差别的那种，或者属性名相同，类型不同 <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p>1024Mbit=128MByte <a href="#fnref3" class="footnote-backref">↩︎</a> <a href="#fnref3:1" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/dubbo_gray.png"/><img class="apache" src="/img/apache_logo.png"/><div class="cols-container"><div class="col col-12"><h3></h3><p></p></div><div class="col col-4"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/user/quick-start.html" target="_self">快速开始</a></dd><dd><a href="/zh-cn/docs/dev/build.html" target="_self">开发者指南</a></dd><dd><a href="/zh-cn/docs/admin/ops/dubbo-ops.html" target="_self">运维管理</a></dd><dd><a href="https://github.com/apache/dubbo-website/issues/new" target="_self">报告文档问题</a></dd><dd><a href="https://github.com/apache/dubbo-website" target="_self">编辑此文档</a></dd></dl></div></div><div class="copyright"><span>TODO Copyright © 2018-2019 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
  <script src="/build/documentation.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-112489517-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-112489517-1');
	</script>
</body>
</html>