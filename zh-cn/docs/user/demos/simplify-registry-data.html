<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="simplify-registry-data" />
	<meta name="description" content="simplify-registry-data" />
	<!-- 网页标签标题 -->
	<title>simplify-registry-data</title>
	<link rel="shortcut icon" href="/img/dubbo.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/dubbo_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a target="_self" href="/zh-cn/index.html">首页</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a target="_self" href="/zh-cn/docs/user/quick-start.html">文档</a></li><li class="menu-item menu-item-normal"><a target="_self" href="/zh-cn/docs/developers/developers_dev.html">开发者</a></li><li class="menu-item menu-item-normal"><a target="_self" href="/zh-cn/blog/download.html">下载</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/docs.png" class="front-img"/><span>文档</span><img src="/img/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>文档</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/user/preface/background.html" target="_self">背景</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/user/quick-start.html" target="_self">快速开始</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>背景</h1>
<p>dubbo provider中的服务配置项有接近<a href="http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-service.html">30个配置项</a>。 排除注册中心服务治理需要之外，很大一部分配置项是provider自己使用，不需要透传给消费者。这部分数据不需要进入注册中心，而只需要以key-value形式持久化存储。</p>
<p>dubbo consumer中的配置项也有<a href="http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-reference.html">20+个配置项</a>。在注册中心之中，服务消费者列表中只需要关注application，version，group，ip，dubbo版本等少量配置，其他配置也可以以key-value形式持久化存储。</p>
<p>这些数据是以服务为维度注册进入注册中心，导致了数据量的膨胀，进而引发注册中心(如zookeeper)的网络开销增大，性能降低。</p>
<h3>现有功能sample</h3>
<p>当前现状一个简单展示。通过这个展示，分析下为什么需要做简化配置。</p>
<p>参考sample子工程： dubbo-samples-simplified-registry/dubbo-samples-simplified-registry-nosimple （跑sample前，先跑下ZKClean进行配置项清理）</p>
<h6>dubbo-provider.xml配置</h6>
<pre><code>&lt;dubbo:application name=&quot;simplified-registry-nosimple-provider&quot;/&gt;
&lt;dubbo:registry address=&quot;zookeeper://127.0.0.1:2181&quot;/&gt;
&lt;bean id=&quot;demoService&quot; class=&quot;org.apache.dubbo.samples.simplified.registry.nosimple.impl.DemoServiceImpl&quot;/&gt;
&lt;dubbo:service async=&quot;true&quot; interface=&quot;org.apache.dubbo.samples.simplified.registry.nosimple.api.DemoService&quot; 
               version=&quot;1.2.3&quot; group=&quot;dubbo-simple&quot; ref=&quot;demoService&quot; 
               executes=&quot;4500&quot; retries=&quot;7&quot; owner=&quot;vict&quot; timeout=&quot;5300&quot;/&gt;
</code></pre>
<p>启动provider的main方法之后，查看zookeeper的叶子节点（路径为：/dubbo/org.apache.dubbo.samples.simplified.registry.nosimple.api.DemoService/providers目录下）的内容如下：</p>
<p>dubbo%3A%2F%2F30.5.124.158%3A20880%2Forg.apache.dubbo.samples.simplified.registry.nosimple.api.DemoService%3Fanyhost%3Dtrue%26application%3Dsimplified-registry-xml-provider%26async%3Dtrue%26dubbo%3D2.0.2%26<strong>executes</strong>%3D4500%26generic%3Dfalse%26group%3Ddubbo-simple%26interface%3Dorg.apache.dubbo.samples.simplified.registry.nosimple.api.DemoService%26methods%3DsayHello%26<strong>owner</strong>%3Dvict%26pid%3D2767%26<strong>retries</strong>%3D7%26revision%3D1.2.3%26side%3Dprovider%26<strong>timeout</strong>%3D5300%26timestamp%3D1542361152795%26valid%3Dtrue%26version%3D1.2.3</p>
<p>从加粗字体中能看到有：executes, retries, owner, timeout. 但是这些字段不是每个都需要传递给dubbo ops或者dubbo consumer。
同样的，consumer也有这个问题，可以在例子中启动Consumer的main方法进行查看。</p>
<h1>设计目标和宗旨</h1>
<p>期望简化进入注册中心的provider和consumer配置数量。
期望将部分配置项以其他形式存储。这些配置项需要满足：不在服务调用链路上，同时这些配置项不在注册中心的核心链路上(服务查询，服务列表)。</p>
<h1>配置</h1>
<p>简化注册中心的配置，只在2.7之后的版本中进行支持。
开启provider或者consumer简化配置之后，默认保留的配置项如下：</p>
<p>provider：</p>
<table>
<thead>
<tr>
<th>Constant Key</th>
<th>Key</th>
<th>remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>APPLICATION_KEY</td>
<td>application</td>
<td></td>
</tr>
<tr>
<td>CODEC_KEY</td>
<td>codec</td>
<td></td>
</tr>
<tr>
<td>EXCHANGER_KEY</td>
<td>exchanger</td>
<td></td>
</tr>
<tr>
<td>SERIALIZATION_KEY</td>
<td>serialization</td>
<td></td>
</tr>
<tr>
<td>CLUSTER_KEY</td>
<td>cluster</td>
<td></td>
</tr>
<tr>
<td>CONNECTIONS_KEY</td>
<td>connections</td>
<td></td>
</tr>
<tr>
<td>DEPRECATED_KEY</td>
<td>deprecated</td>
<td></td>
</tr>
<tr>
<td>GROUP_KEY</td>
<td>group</td>
<td></td>
</tr>
<tr>
<td>LOADBALANCE_KEY</td>
<td>loadbalance</td>
<td></td>
</tr>
<tr>
<td>MOCK_KEY</td>
<td>mock</td>
<td></td>
</tr>
<tr>
<td>PATH_KEY</td>
<td>path</td>
<td></td>
</tr>
<tr>
<td>TIMEOUT_KEY</td>
<td>timeout</td>
<td></td>
</tr>
<tr>
<td>TOKEN_KEY</td>
<td>token</td>
<td></td>
</tr>
<tr>
<td>VERSION_KEY</td>
<td>version</td>
<td></td>
</tr>
<tr>
<td>WARMUP_KEY</td>
<td>warmup</td>
<td></td>
</tr>
<tr>
<td>WEIGHT_KEY</td>
<td>weight</td>
<td></td>
</tr>
<tr>
<td>TIMESTAMP_KEY</td>
<td>timestamp</td>
<td></td>
</tr>
<tr>
<td>DUBBO_VERSION_KEY</td>
<td>dubbo</td>
<td></td>
</tr>
<tr>
<td>SPECIFICATION_VERSION_KEY</td>
<td><strong>specVersion</strong></td>
<td>新增，用于表述dubbo版本，如2.7.0</td>
</tr>
</tbody>
</table>
<p>consumer：</p>
<table>
<thead>
<tr>
<th>Constant Key</th>
<th>Key</th>
<th>remark</th>
</tr>
</thead>
<tbody>
<tr>
<td>APPLICATION_KEY</td>
<td>application</td>
<td></td>
</tr>
<tr>
<td>VERSION_KEY</td>
<td>version</td>
<td></td>
</tr>
<tr>
<td>GROUP_KEY</td>
<td>group</td>
<td></td>
</tr>
<tr>
<td>DUBBO_VERSION_KEY</td>
<td>dubbo</td>
<td></td>
</tr>
<tr>
<td>SPECIFICATION_VERSION_KEY</td>
<td><strong>specVersion</strong></td>
<td>新增，用于表述dubbo版本，如2.7.0</td>
</tr>
</tbody>
</table>
<p>Constant Key表示来自于类org.apache.dubbo.common.Constants的字段。</p>
<p>下面介绍几种常用的使用方式。所有的sample，都可以查看<a href="https://github.com/dubbo/dubbo-samples/tree/master">sample-2.7</a></p>
<h3>方式1. 配置dubbo.properties</h3>
<p>sample在dubbo-samples-simplified-registry/dubbo-samples-simplified-registry-xml 工程下 （跑sample前，先跑下ZKClean进行配置项清理）</p>
<p>dubbo.properties</p>
<pre><code class="language-properties">
<span class="hljs-meta">dubbo.registry.simplified</span>=<span class="hljs-string">true</span>
<span class="hljs-meta">dubbo.registry.extra-keys</span>=<span class="hljs-string">retries,owner</span>
</code></pre>
<p>怎么去验证呢？</p>
<h5>provider端验证</h5>
<p>provider端配置</p>
<pre><code class="language-xml">
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">"http://dubbo.apache.org/schema/dubbo"</span>
       <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd
       http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd"</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- optional --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"simplified-registry-xml-provider"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">"zookeeper://127.0.0.1:2181"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"demoService"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"org.apache.dubbo.samples.simplified.registry.nosimple.impl.DemoServiceImpl"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:service</span> <span class="hljs-attr">async</span>=<span class="hljs-string">"true"</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">"org.apache.dubbo.samples.simplified.registry.nosimple.api.DemoService"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.2.3"</span> <span class="hljs-attr">group</span>=<span class="hljs-string">"dubbo-simple"</span>
                   <span class="hljs-attr">ref</span>=<span class="hljs-string">"demoService"</span> <span class="hljs-attr">executes</span>=<span class="hljs-string">"4500"</span> <span class="hljs-attr">retries</span>=<span class="hljs-string">"7"</span> <span class="hljs-attr">owner</span>=<span class="hljs-string">"vict"</span> <span class="hljs-attr">timeout</span>=<span class="hljs-string">"5300"</span>/&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<p>得到的zookeeper的叶子节点的值如下：</p>
<p>dubbo%3A%2F%2F30.5.124.149%3A20880%2Forg.apache.dubbo.samples.simplified.registry.nosimple.api.DemoService%3Fapplication%3Dsimplified-registry-xml-provider%26dubbo%3D2.0.2%26group%3Ddubbo-simple%26<strong>owner</strong>%3Dvict%26<strong>retries</strong>%3D7%26<strong>timeout</strong>%3D5300%26timestamp%3D1542594503305%26version%3D1.2.3</p>
<p>和上面的<code>现有功能sample</code> 进行对比，上面的sample中，executes, retries, owner, timeout四个配置项都进入了注册中心。但是本实例不是：</p>
<ul>
<li>配置了：dubbo.registry.simplified=true， 默认情况下，timeout在默认的配置项列表，所以还是会进入注册中心；</li>
<li>配置了：dubbo.registry.extra-keys=retries,owner ， 所以retries，owner也会进入注册中心。</li>
</ul>
<p>总结：timeout，retries,owner进入了注册中心，而executes没有进入。</p>
<p>consumer端配置</p>
<pre><code class="language-xml">
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="hljs-attr">xmlns:dubbo</span>=<span class="hljs-string">"http://dubbo.apache.org/schema/dubbo"</span>
       <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans"</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd
       http://dubbo.apache.org/schema/dubbo http://dubbo.apache.org/schema/dubbo/dubbo.xsd"</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- optional --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:application</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"simplified-registry-xml-consumer"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:registry</span> <span class="hljs-attr">address</span>=<span class="hljs-string">"zookeeper://127.0.0.1:2181"</span> <span class="hljs-attr">username</span>=<span class="hljs-string">"xxx"</span> <span class="hljs-attr">password</span>=<span class="hljs-string">"yyy"</span> <span class="hljs-attr">check</span>=<span class="hljs-string">"true"</span>/&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">dubbo:reference</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"demoService"</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">"org.apache.dubbo.samples.simplified.registry.nosimple.api.DemoService"</span>
                     <span class="hljs-attr">owner</span>=<span class="hljs-string">"vvv"</span> <span class="hljs-attr">retries</span>=<span class="hljs-string">"4"</span> <span class="hljs-attr">actives</span>=<span class="hljs-string">"6"</span> <span class="hljs-attr">timeout</span>=<span class="hljs-string">"4500"</span> <span class="hljs-attr">version</span>=<span class="hljs-string">"1.2.3"</span> <span class="hljs-attr">group</span>=<span class="hljs-string">"dubbo-simple"</span>/&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<p>得到的zookeeper的叶子节点的值如下：</p>
<p>consumer%3A%2F%2F30.5.124.149%2Forg.apache.dubbo.samples.simplified.registry.nosimple.api.DemoService%3Factives%3D6%26application%3Dsimplified-registry-xml-consumer%26category%3Dconsumers%26check%3Dfalse%26dubbo%3D2.0.2%26group%3Ddubbo-simple%26owner%3Dvvv%26version%3D1.2.3</p>
<ul>
<li>配置了：dubbo.registry.simplified=true ， 默认情况下，application,version,group,dubbo在默认的配置项列表，所以还是会进入注册中心；</li>
</ul>
<h3>方式2. 声明spring bean</h3>
<p>sample在dubbo-samples-simplified-registry/dubbo-samples-simplified-registry-annotation 工程下 （跑sample前，先跑下ZKClean进行配置项清理）</p>
<h5>Provider配置</h5>
<p>privide端bean配置：</p>
<pre><code>// 等同于dubbo.properties配置，用@Bean形式进行配置
        @Bean
        public RegistryConfig registryConfig() {
            RegistryConfig registryConfig = new RegistryConfig();
            registryConfig.setAddress(&quot;zookeeper://127.0.0.1:2181&quot;);
            registryConfig.setSimplified(true);
            registryConfig.setExtraKeys(&quot;retries,owner&quot;);
            return registryConfig;
        }
</code></pre>
<pre><code>// 暴露服务
@Service(version = &quot;1.1.8&quot;, group = &quot;d-test&quot;, executes = 4500, retries = 7, owner = &quot;victanno&quot;, timeout = 5300)
public class AnnotationServiceImpl implements AnnotationService {
    @Override
    public String sayHello(String name) {
        System.out.println(&quot;async provider received: &quot; + name);
        return &quot;annotation: hello, &quot; + name;
    }
}
</code></pre>
<p>和上面sample中的dubbo.properties的效果是一致的。结果如下：</p>
<ul>
<li>默认情况下，timeout在默认的配置项列表，所以还是会进入注册中心；</li>
<li>配置了retries,owner 作为额外的key进入注册中心 ， 所以retries，owner也会进入注册中心。</li>
</ul>
<p>总结：timeout，retries,owner进入了注册中心，而executes没有进入。</p>
<h5>Consumer配置</h5>
<p>consumer端bean配置：</p>
<pre><code>  @Bean
  public RegistryConfig registryConfig() {
      RegistryConfig registryConfig = new RegistryConfig();
      registryConfig.setAddress(&quot;zookeeper://127.0.0.1:2181&quot;);
      registryConfig.setSimplified(true);
      return registryConfig;
  }
</code></pre>
<p>消费服务：</p>
<pre><code>@Component(&quot;annotationAction&quot;)
public class AnnotationAction {

    @Reference(version = &quot;1.1.8&quot;, group = &quot;d-test&quot;, owner = &quot;vvvanno&quot;, retries = 4, actives = 6, timeout = 4500)
    private AnnotationService annotationService;
    public String doSayHello(String name) {
        return annotationService.sayHello(name);
    }
}
</code></pre>
<p>和上面sample中consumer端的配置是一样的。结果如下：</p>
<ul>
<li>默认情况下，application,version,group,dubbo在默认的配置项列表，所以还是会进入注册中心.</li>
</ul>
<h6>注意：</h6>
<p>如果一个应用中既有provider又有consumer，那么配置需要合并成：</p>
<pre><code>    @Bean
    public RegistryConfig registryConfig() {
        RegistryConfig registryConfig = new RegistryConfig();
        registryConfig.setAddress(&quot;zookeeper://127.0.0.1:2181&quot;);
        registryConfig.setSimplified(true);
        //只对provider生效
        registryConfig.setExtraKeys(&quot;retries,owner&quot;);
        return registryConfig;
    }
</code></pre>
<h1>后续规划</h1>
<p>本版本还保留了大量的配置项，接下来的版本中，会逐渐删除所有的配置项。</p>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/dubbo_gray.png"/><img class="apache" src="/img/apache_logo.png"/><div class="cols-container"><div class="col col-12"><h3></h3><p></p></div><div class="col col-4"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/user/quick-start.html" target="_self">快速开始</a></dd><dd><a href="/zh-cn/docs/dev/build.html" target="_self">开发者指南</a></dd><dd><a href="/zh-cn/docs/admin/ops/dubbo-ops.html" target="_self">运维管理</a></dd><dd><a href="https://github.com/apache/dubbo-website/issues/new" target="_self">报告文档问题</a></dd><dd><a href="https://github.com/apache/dubbo-website" target="_self">编辑此文档</a></dd></dl></div></div><div class="copyright"><span>TODO Copyright © 2018-2019 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
  <script src="/build/documentation.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-112489517-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-112489517-1');
	</script>
</body>
</html>