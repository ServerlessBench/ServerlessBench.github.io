<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="introduction" />
	<meta name="description" content="introduction" />
	<!-- 网页标签标题 -->
	<title>introduction</title>
	<link rel="shortcut icon" href="/img/dubbo.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/en-us/index.html"><img class="logo" src="/img/dubbo_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">中</span><div class="header-menu"><img class="header-menu-toggle" src="/img/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a target="_self" href="/en-us/index.html">HOME</a></li><li class="menu-item menu-item-normal menu-item-normal-active"><a target="_self" href="/en-us/docs/user/quick-start.html">DOCS</a></li><li class="menu-item menu-item-normal"><a target="_self" href="/en-us/docs/developers/developers_dev.html">DEVELOPERS</a></li><li class="menu-item menu-item-normal"><a target="_self" href="/en-us/blog/download.html">DOWNLOAD</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/docs.png" class="front-img"/><span>Documentation</span><img src="/img/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>Document</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/user/preface/background.html" target="_self">Background</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/en-us/docs/user/quick-start.html" target="_self">Quick start</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>Background</h1>
<p>There are close to <a href="http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-service.html">30 configurations</a> in dubbo provider. Excluding registry center governance requirements, a large part of configurations are used by the provider itself and do not need to be delivered to the consumer. This part of the data does not need to be written to the registry, but only needs to be persisted as key-value.
There are also <a href="http://dubbo.apache.org/en-us/docs/user/references/xml/dubbo-reference.html">20+ configurations</a> in dubbo consumer. In the registry center, only a few configurations such as application, version, group, ip, dubbo version are needed in the list of service consumers. Other configurations can also be persisted in key-value form.
This data is registered into the registry in the service dimension, which leads to the expansion of data volume, and then causes the increased network overhead of the registry (such as zookeeper) and decreased performance.</p>
<p>In addition to the storage of the above configuration items, Dubbo service metadata information also needs to be stored. Metadata information includes service interface and method information of interface. This information will be used for service mock, service test.</p>
<h1>Goal</h1>
<p>The original data and metadata information in the registry center need to be stored in a separate key-value store, which can be DB, redis or other persistent storage. The core code supports zookeeper, redis(recommended) by default.</p>
<p>The format of provider storage content is the storage after gson's serialization of org.apache.dubbo.metadata.definition.model.FullServiceDefinition.
Consumer gets parameter information from the URL that it wrote to the registry and stores it in Map. That is, get the Map with URL.getParameterMap() and store it after gson's serialization.</p>
<p>For more details, you can refer to the sample below.</p>
<h1>Configuration</h1>
<p>The default metadata storage supports the following additional features:</p>
<ul>
<li>Failed retry</li>
<li>Refresh regularly</li>
</ul>
<h4>Failed retry</h4>
<p>Failed retries can be configured by retrytimes (retry times, default 100), retryperiod (retry cycle, default 3000ms).</p>
<h4>Refresh regularly</h4>
<p>It's opening by default and can be turned off by setting cycleReport=false.</p>
<h4>Complete configurations:</h4>
<pre><code>dubbo.metadata-report.address=zookeeper://127.0.0.1:2181
dubbo.metadata-report.username=xxx        ##Not necessary
dubbo.metadata-report.password=xxx        ##Not necessary
dubbo.metadata-report.retry-times=30       ##Not necessary,default 100
dubbo.metadata-report.retry-period=5000    ##Not necessary,default 3000
dubbo.metadata-report.cycle-report=false   ##Not necessary,default true
</code></pre>
<blockquote>
<p>If the metadata address (dubbo.metadata-report.address) is not configured, the writing of the entire metadata will not take effect, but it will not affect the running of the program.</p>
</blockquote>
<p>Let's look at a few sample configurations. Regardless of the configuration, some maven dependencies need to be introduced:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;
    &lt;artifactId&gt;dubbo-metadata-report-zookeeper&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<p>If redis is needed, the corresponding redis dependencies can be introduced:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.apache.dubbo&lt;/groupId&gt;
    &lt;artifactId&gt;dubbo-metadata-report-redis&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre>
<blockquote>
<p><strong>Complete sample，refer to<a href="https://github.com/dubbo/dubbo-samples/tree/master">sample-2.7</a></strong></p>
</blockquote>
<h2>Method 1: Config in Configcenter</h2>
<p>Refer to the sample: dubbo-samples-metadata-report/dubbo-samples-metadata-report-configcenter.</p>
<h5>Configcenter Configuration</h5>
<p>Configurations of Configcenter，can refer to the document of Configcenter. As follows:</p>
<pre><code class="language-.properties">dubbo.registry.address=zookeeper://127.0.0.1:2181
### Notice the hump style
dubbo.metadata-report.address=zookeeper://127.0.0.1:2181 ###Address of metadata storage
</code></pre>
<p>In the sample, Zookeeper is used as the Configcenter. Run directly: org.Apache.Dubbo.Samples.Metadatareport.Configcenter.ZKTools after starting a local zookeeper service, then writing finished.
You can also use Nacos, Apollo as the Configcenter. These products themselves support ops configuration.</p>
<h5>Application Configuration</h5>
<pre><code>###dubbo.properties
dubbo.config-center.address=zookeeper://127.0.0.1:2181
... 
</code></pre>
<p>After completing the above two steps, the registry address and metadata address are retrieved from the Configcenter. You can now run the Provider and the Consumer in turn and get the corresponding output in console or view it directly through the client of zookeeper.</p>
<h5>Provider Configuration</h5>
<p>The metadata stored on the Provider side is as follows:</p>
<pre><code class="language-json">{
 <span class="hljs-attr">"parameters"</span>: {
  <span class="hljs-attr">"side"</span>: <span class="hljs-string">"provider"</span>,
  <span class="hljs-attr">"methods"</span>: <span class="hljs-string">"sayHello"</span>,
  <span class="hljs-attr">"dubbo"</span>: <span class="hljs-string">"2.0.2"</span>,
  <span class="hljs-attr">"threads"</span>: <span class="hljs-string">"100"</span>,
  <span class="hljs-attr">"interface"</span>: <span class="hljs-string">"org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService"</span>,
  <span class="hljs-attr">"threadpool"</span>: <span class="hljs-string">"fixed"</span>,
  <span class="hljs-attr">"version"</span>: <span class="hljs-string">"1.1.1"</span>,
  <span class="hljs-attr">"generic"</span>: <span class="hljs-string">"false"</span>,
  <span class="hljs-attr">"revision"</span>: <span class="hljs-string">"1.1.1"</span>,
  <span class="hljs-attr">"valid"</span>: <span class="hljs-string">"true"</span>,
  <span class="hljs-attr">"application"</span>: <span class="hljs-string">"metadatareport-configcenter-provider"</span>,
  <span class="hljs-attr">"default.timeout"</span>: <span class="hljs-string">"5000"</span>,
  <span class="hljs-attr">"group"</span>: <span class="hljs-string">"d-test"</span>,
  <span class="hljs-attr">"anyhost"</span>: <span class="hljs-string">"true"</span>
 },
 <span class="hljs-attr">"canonicalName"</span>: <span class="hljs-string">"org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService"</span>,
 <span class="hljs-attr">"codeSource"</span>: <span class="hljs-string">"file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-configcenter/target/classes/"</span>,
 <span class="hljs-attr">"methods"</span>: [{
  <span class="hljs-attr">"name"</span>: <span class="hljs-string">"sayHello"</span>,
  <span class="hljs-attr">"parameterTypes"</span>: [<span class="hljs-string">"java.lang.String"</span>],
  <span class="hljs-attr">"returnType"</span>: <span class="hljs-string">"java.lang.String"</span>
 }],
 <span class="hljs-attr">"types"</span>: [{
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"java.lang.String"</span>,
  <span class="hljs-attr">"properties"</span>: {
   <span class="hljs-attr">"value"</span>: {
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"char[]"</span>
   },
   <span class="hljs-attr">"hash"</span>: {
    <span class="hljs-attr">"type"</span>: <span class="hljs-string">"int"</span>
   }
  }
 }, {
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"int"</span>
 }, {
  <span class="hljs-attr">"type"</span>: <span class="hljs-string">"char"</span>
 }]
}

</code></pre>
<p>The Provider side stores all the parameters that the Provider service fills in to the registry, as well as the method information of the service (method name, input and output format).</p>
<h5>Consumer Configuration</h5>
<pre><code>{
 &quot;valid&quot;: &quot;true&quot;,
 &quot;side&quot;: &quot;consumer&quot;,
 &quot;application&quot;: &quot;metadatareport-configcenter-consumer&quot;,
 &quot;methods&quot;: &quot;sayHello&quot;,
 &quot;default.timeout&quot;: &quot;6666&quot;,
 &quot;dubbo&quot;: &quot;2.0.2&quot;,
 &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.configcenter.api.AnnotationService&quot;,
 &quot;version&quot;: &quot;1.1.1&quot;,
 &quot;revision&quot;: &quot;1.1.1&quot;,
 &quot;group&quot;: &quot;d-test&quot;
}
</code></pre>
<p>The Consumer side stores all the parameters that the Consumer fills in to the registry.</p>
<p>The above example is mainly a presentation of the provider side service information and consumer side service information stored in the metadata area by placing the metadata address in the Configcenter.
The next two examples focus on configuring in a project: the XML mode and the annotation mode .</p>
<h2>Method 2: Config project in properties way</h2>
<p>Refer to the sample: dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-xml.</p>
<h5>dubbo.properties</h5>
<pre><code>dubbo.metadata-report.address=zookeeper://127.0.0.1:2181
</code></pre>
<p>After setting this configuration, have not to focus on others. You can also view the service information of the corresponding provider and consumer directly.</p>
<h5>Provider stores:</h5>
<pre><code>{
 &quot;parameters&quot;: {
  &quot;valid&quot;: &quot;true&quot;,
  &quot;async&quot;: &quot;true&quot;,
  &quot;side&quot;: &quot;provider&quot;,
  &quot;application&quot;: &quot;metadatareport-local-xml-provider&quot;,
  &quot;methods&quot;: &quot;sayHello&quot;,
  &quot;dubbo&quot;: &quot;2.0.2&quot;,
  &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.xml.api.DemoService&quot;,
  &quot;generic&quot;: &quot;false&quot;,
  &quot;anyhost&quot;: &quot;true&quot;
 },
 &quot;canonicalName&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.xml.api.DemoService&quot;,
 &quot;codeSource&quot;: &quot;file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-xml/target/classes/&quot;,
 &quot;methods&quot;: [{
  &quot;name&quot;: &quot;sayHello&quot;,
  &quot;parameterTypes&quot;: [&quot;java.lang.String&quot;],
  &quot;returnType&quot;: &quot;java.lang.String&quot;
 }],
 &quot;types&quot;: [{
  &quot;type&quot;: &quot;int&quot;
 }, {
  &quot;type&quot;: &quot;char&quot;
 }, {
  &quot;type&quot;: &quot;java.lang.String&quot;,
  &quot;properties&quot;: {
   &quot;value&quot;: {
    &quot;type&quot;: &quot;char[]&quot;
   },
   &quot;hash&quot;: {
    &quot;type&quot;: &quot;int&quot;
   }
  }
 }]
}

</code></pre>
<h5>Consumer stores:</h5>
<pre><code>{
 &quot;valid&quot;: &quot;true&quot;,
 &quot;side&quot;: &quot;consumer&quot;,
 &quot;application&quot;: &quot;metadatareport-local-xml-consumer&quot;,
 &quot;methods&quot;: &quot;sayHello&quot;,
 &quot;dubbo&quot;: &quot;2.0.2&quot;,
 &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.xml.api.DemoService&quot;
}

</code></pre>
<h2>Method 3: Config project in annotation way</h2>
<p>Refer to the sample: dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-annotaion.</p>
<h5>@Bean introduce Bean</h5>
<pre><code>@Bean
public MetadataReportConfig metadataReportConfig() {
    MetadataReportConfig metadataReportConfig = new MetadataReportConfig();
    metadataReportConfig.setAddress(&quot;zookeeper://127.0.0.1:2181&quot;);
    return metadataReportConfig;
}

</code></pre>
<p>After introducing Bean, also have not to set others. View corresponding service information directly:</p>
<h5>Provider stores:</h5>
<pre><code>{
 &quot;parameters&quot;: {
  &quot;side&quot;: &quot;provider&quot;,
  &quot;methods&quot;: &quot;sayHello&quot;,
  &quot;dubbo&quot;: &quot;2.0.2&quot;,
  &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.annotation.api.AnnotationService&quot;,
  &quot;version&quot;: &quot;1.1.8&quot;,
  &quot;generic&quot;: &quot;false&quot;,
  &quot;revision&quot;: &quot;1.1.8&quot;,
  &quot;valid&quot;: &quot;true&quot;,
  &quot;application&quot;: &quot;metadatareport-local-annotaion-provider&quot;,
  &quot;default.timeout&quot;: &quot;1000&quot;,
  &quot;group&quot;: &quot;d-test&quot;,
  &quot;anyhost&quot;: &quot;true&quot;
 },
 &quot;canonicalName&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.annotation.api.AnnotationService&quot;,
 &quot;codeSource&quot;: &quot;file:/Users/cvictory/workspace/work-mw/dubbo-samples/dubbo-samples-metadata-report/dubbo-samples-metadata-report-local-annotaion/target/classes/&quot;,
 &quot;methods&quot;: [{
  &quot;name&quot;: &quot;sayHello&quot;,
  &quot;parameterTypes&quot;: [&quot;java.lang.String&quot;],
  &quot;returnType&quot;: &quot;java.lang.String&quot;
 }],
 &quot;types&quot;: [{
  &quot;type&quot;: &quot;int&quot;
 }, {
  &quot;type&quot;: &quot;java.lang.String&quot;,
  &quot;properties&quot;: {
   &quot;value&quot;: {
    &quot;type&quot;: &quot;char[]&quot;
   },
   &quot;hash&quot;: {
    &quot;type&quot;: &quot;int&quot;
   }
  }
 }, {
  &quot;type&quot;: &quot;char&quot;
 }]
}
</code></pre>
<h5>Consumer stores:</h5>
<pre><code>{
 &quot;valid&quot;: &quot;true&quot;,
 &quot;side&quot;: &quot;consumer&quot;,
 &quot;application&quot;: &quot;metadatareport-local-annotaion-consumer&quot;,
 &quot;methods&quot;: &quot;sayHello&quot;,
 &quot;dubbo&quot;: &quot;2.0.2&quot;,
 &quot;interface&quot;: &quot;org.apache.dubbo.samples.metadatareport.local.annotation.api.AnnotationService&quot;,
 &quot;version&quot;: &quot;1.1.8&quot;,
 &quot;revision&quot;: &quot;1.1.8&quot;,
 &quot;group&quot;: &quot;d-test&quot;
}
</code></pre>
<h1>Extension</h1>
<h2>SPI Definition</h2>
<p>Refer to: org.apache.dubbo.metadata.store.MetadataReportFactory, org.apache.dubbo.metadata.store.MetadataReport</p>
<pre><code>@SPI(&quot;redis&quot;)
public interface MetadataReportFactory {
    @Adaptive({&quot;protocol&quot;})
    MetadataReport getMetadataReport(URL url);
}
</code></pre>
<h2>Custom metadata storage</h2>
<p>Let's take Redis storage as an example to illustrate.</p>
<p>Create a new project supporting the following modifications:</p>
<h4>Extend AbstractMetadataReport</h4>
<pre><code>public class RedisMetadataReport extends AbstractMetadataReport {
    private final static Logger logger = LoggerFactory.getLogger(RedisMetadataReport.class);
    final JedisPool pool;
	
    public RedisMetadataReport(URL url) {
        super(url);
        pool = new JedisPool(new JedisPoolConfig(), url.getHost(), url.getPort());
    }
    @Override
    protected void doStoreProviderMetadata(ProviderMetadataIdentifier providerMetadataIdentifier, String serviceDefinitions) {
        this.storeMetadata(providerMetadataIdentifier, serviceDefinitions);
    }
    @Override
    protected void doStoreConsumerMetadata(ConsumerMetadataIdentifier consumerMetadataIdentifier, String value) {
        this.storeMetadata(consumerMetadataIdentifier, value);
    }
    private void storeMetadata(MetadataIdentifier metadataIdentifier, String v) {
        try (Jedis jedis = pool.getResource()) {
            jedis.set(metadataIdentifier.getIdentifierKey() + META_DATA_SOTRE_TAG, v);
        } catch (Throwable e) {
            logger.error(&quot;Failed to put &quot; + metadataIdentifier + &quot; to redis &quot; + v + &quot;, cause: &quot; + e.getMessage(), e);
            throw new RpcException(&quot;Failed to put &quot; + metadataIdentifier + &quot; to redis &quot; + v + &quot;, cause: &quot; + e.getMessage(), e);
        }
    }
}
</code></pre>
<h4>Extend AbstractMetadataReportFactory</h4>
<pre><code>public class RedisMetadataReportFactory extends AbstractMetadataReportFactory {
    @Override
    public MetadataReport createMetadataReport(URL url) {
        return new RedisMetadataReport(url);
    }
}
</code></pre>
<h4>New META-INF/dubbo/internal/org.apache.dubbo.metadata.store.MetadataReportFactory</h4>
<pre><code>redis=org.apache.dubbo.metadata.store.redis.RedisMetadataReportFactory
</code></pre>
<p>As long as the above modifications along with the project are packaged into a jar, then config metadata center url: redis://10.20.153.10:6379.</p>
<p>Up to now, a custom metadata store is ready to run.</p>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/dubbo_gray.png"/><img class="apache" src="/img/apache_logo.png"/><div class="cols-container"><div class="col col-12"><h3></h3><p></p></div><div class="col col-4"><dl><dt>Documentation</dt><dd><a href="/en-us/docs/user/quick-start.html" target="_self">Quick start</a></dd><dd><a href="/en-us/docs/dev/build.html" target="_self">Developer guide</a></dd><dd><a href="/en-us/docs/admin/ops/dubbo-ops.html" target="_self">Admin manual</a></dd><dd><a href="https://github.com/apache/dubbo-website/issues/new" target="_self">Report a Doc Issue</a></dd><dd><a href="https://github.com/apache/dubbo-website" target="_self">Edit This Page on GitHub</a></dd></dl></div></div><div class="copyright"><span>TODO Copyright © 2018-2019 The Apache Software Foundation. Apache and the Apache feather logo are trademarks of The Apache Software Foundation.</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
  <script src="/build/documentation.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-112489517-1"></script>
	<script>
		window.dataLayer = window.dataLayer || [];
		function gtag(){dataLayer.push(arguments);}
		gtag('js', new Date());

		gtag('config', 'UA-112489517-1');
	</script>
</body>
</html>